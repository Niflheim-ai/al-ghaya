# PayMongo 403 CloudFront Error - Fix Summary

## üêû The Problem

You were experiencing this error when trying to create PayMongo checkout sessions:

```
PayMongo API Error (HTTP 403): <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"...>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
Request blocked.
Generated by cloudfront (CloudFront)
```

**Root Cause**: CloudFront (PayMongo's CDN) was blocking API requests due to:
1. Missing `User-Agent` header in HTTP requests
2. Potentially invalid or misconfigured API keys
3. Insufficient cURL configuration for CloudFront's requirements

---

## ‚úÖ The Solution

I've made several critical updates to fix the 403 error and improve PayMongo integration:

### 1. **Updated `php/paymongo-helper.php`**

**Key Changes:**
- ‚úÖ Added `User-Agent` header to all API requests
- ‚úÖ Improved SSL certificate verification
- ‚úÖ Added connection and request timeouts (10s connect, 30s total)
- ‚úÖ Enabled `CURLOPT_FOLLOWLOCATION` to handle CloudFront redirects
- ‚úÖ Enhanced error logging with detailed 403 diagnostics
- ‚úÖ Better response parsing and error handling

**Before (problematic code):**
```php
$headers = [
    'Authorization: Basic ' . base64_encode(PAYMONGO_SECRET_KEY . ':'),
    'Content-Type: application/json',
    'Accept: application/json'
    // Missing User-Agent!
];

curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, !PAYMONGO_TEST_MODE);
// No timeout, no redirect handling
```

**After (fixed code):**
```php
$headers = [
    'Authorization: Basic ' . base64_encode(PAYMONGO_SECRET_KEY . ':'),
    'Content-Type: application/json',
    'Accept: application/json',
    'User-Agent: Al-Ghaya-LMS/1.0 (PHP/' . PHP_VERSION . ')' // ‚úÖ ADDED
];

curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
curl_setopt($ch, CURLOPT_TIMEOUT, 30);              // ‚úÖ ADDED
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);      // ‚úÖ ADDED
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);    // ‚úÖ ADDED
curl_setopt($ch, CURLOPT_MAXREDIRS, 3);            // ‚úÖ ADDED
```

### 2. **Created `php/test-paymongo.php`** (NEW)

A comprehensive diagnostic tool that:
- ‚úÖ Validates API key format and configuration
- ‚úÖ Tests connection to PayMongo API
- ‚úÖ Identifies specific error causes
- ‚úÖ Provides step-by-step troubleshooting guidance
- ‚úÖ Tests checkout session creation

**Usage:**
```
http://localhost/al-ghaya/php/test-paymongo.php
```

### 3. **Created `PAYMONGO_SETUP.md`** (NEW)

Complete setup and troubleshooting guide covering:
- ‚úÖ Common 403 error causes and solutions
- ‚úÖ Step-by-step API key configuration
- ‚úÖ Testing checklist
- ‚úÖ Production deployment guidelines
- ‚úÖ Security best practices

### 4. **Created `env.example`** (NEW)

Template for environment configuration with:
- ‚úÖ All required PayMongo settings
- ‚úÖ Clear comments and examples
- ‚úÖ Separate test/production configurations

---

## üõ†Ô∏è What You Need to Do

### Step 1: Update Your Local Files

Pull the latest changes from the repository:

```bash
cd /path/to/al-ghaya
git pull origin main
```

### Step 2: Verify Your `.env` File

Make sure your `.env` file exists in the root folder and contains:

```env
PAYMONGO_SECRET_KEY=sk_test_your_actual_key_here
PAYMONGO_PUBLIC_KEY=pk_test_your_actual_key_here
PAYMONGO_TEST_MODE=true
APP_URL=http://localhost/al-ghaya
```

**How to Get Valid API Keys:**
1. Log in to https://dashboard.paymongo.com/
2. Go to **Developers** ‚Üí **API Keys**
3. Copy your **Secret Key** (starts with `sk_test_`)
4. Copy your **Public Key** (starts with `pk_test_`)
5. Paste them into your `.env` file

### Step 3: Test the Connection

1. Restart your Apache server in XAMPP
2. Navigate to: `http://localhost/al-ghaya/php/test-paymongo.php`
3. Check if all tests pass

**Expected Output:**
```
[TEST 1] Checking API Keys Configuration
‚úÖ Secret Key format looks correct
‚úÖ Public Key format looks correct

[TEST 2] Testing PayMongo API Connection
‚úÖ SUCCESS: API connection is working!

[TEST 3] Testing Checkout Session Creation
‚úÖ SUCCESS: Checkout session created successfully!
```

### Step 4: Test Payment Flow

1. Log in as a student
2. Try to enroll in a paid program
3. Verify that:
   - No 403 errors appear in Apache error log
   - PayMongo checkout page opens successfully
   - Payment can be completed (use test payment methods)

---

## üö® If You Still Get 403 Errors

### Check These:

1. **API Keys Are Valid**
   - Log in to PayMongo dashboard
   - Verify your account is activated and verified
   - Generate new API keys if needed

2. **Environment Variables Are Loaded**
   - Check that `.env` file is in the correct location (root of al-ghaya folder)
   - Restart Apache after changing `.env`
   - Verify keys are not empty or contain placeholder text

3. **Account Status**
   - Your PayMongo account must be verified
   - Test mode must be enabled for development
   - Check for any restrictions or limitations on your account

4. **Firewall/Network Issues**
   - Ensure your firewall allows outbound HTTPS requests
   - Check if your internet connection is stable
   - Try disabling antivirus temporarily to test

---

## üìä Testing Payment Methods

### In Test Mode:

**GCash Test:**
- Use any valid mobile number
- Select "Success" on the test page

**Credit Card Test:**
- Success: `4120 0000 0000 0007`
- Expiry: Any future date
- CVC: Any 3 digits

---

## üì¶ Files Changed

| File | Status | Description |
|------|--------|-------------|
| `php/paymongo-helper.php` | ‚úÖ Updated | Fixed cURL configuration and added User-Agent |
| `php/test-paymongo.php` | ‚úÖ New | Diagnostic and testing tool |
| `PAYMONGO_SETUP.md` | ‚úÖ New | Comprehensive setup guide |
| `env.example` | ‚úÖ New | Environment configuration template |
| `PAYMONGO_FIX_SUMMARY.md` | ‚úÖ New | This summary document |

---

## ‚úÖ Success Indicators

You'll know the fix worked when:

1. ‚úÖ Test script passes all checks
2. ‚úÖ No 403 errors in Apache error log
3. ‚úÖ Checkout URL is generated successfully
4. ‚úÖ PayMongo checkout page loads
5. ‚úÖ Payments are processed and recorded
6. ‚úÖ Student enrollments are created

---

## üìû Support

If you continue to experience issues:

1. **Run the test script** and save the output
2. **Check Apache error log** for detailed error messages
3. **Contact PayMongo support** at support@paymongo.com
4. **Review PayMongo documentation** at https://developers.paymongo.com/

---

**Date Fixed**: November 19, 2025  
**Commits**: 
- `7beba8aa` - Fix PayMongo 403 CloudFront error
- `ffc3eb7c` - Add test script
- `d0879b0a` - Add setup guide
- `c3d0c84c` - Add environment template

---

Good luck! üöÄ Your PayMongo integration should now work correctly.